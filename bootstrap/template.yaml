AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Simple Multiplexer Gateway bootstrap (shared config bucket + macro + config publisher custom resource)

Parameters:
  UseExistingBucket:
    Type: String
    Default: ""
    Description: Optional existing S3 bucket name to use for gateway config/spec objects. Leave empty to create a bucket named smug-config-<account>-<region>.
  DefaultGatewayRepositoryName:
    Type: String
    Default: simple-multiplexer-gateway/gateway
    Description: ECR repository name for the default gateway image.
  DefaultGatewayImageTag:
    Type: String
    Default: 0.0.0
    Description: Default gateway image tag (pinned, not latest).
  DefaultGatewayImageIdentifier:
    Type: String
    Default: ""
    Description: Optional full gateway image identifier (overrides repository + tag when set).

Conditions:
  CreateConfigBucket: !Equals [!Ref UseExistingBucket, ""]
  HasDefaultGatewayImageIdentifier: !Not [!Equals [!Ref DefaultGatewayImageIdentifier, ""]]

Resources:
  ConfigBucket:
    Type: AWS::S3::Bucket
    Condition: CreateConfigBucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Sub "smug-config-${AWS::AccountId}-${AWS::Region}"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  ConfigBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: CreateConfigBucket
    Properties:
      Bucket: !Ref ConfigBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: DenyInsecureTransport
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !Sub "arn:aws:s3:::${ConfigBucket}"
              - !Sub "arn:aws:s3:::${ConfigBucket}/*"
            Condition:
              Bool:
                aws:SecureTransport: false

  ConfigPublisherFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.13
      Handler: app.handler
      CodeUri: config_publisher/
      Description: CloudFormation custom resource that uploads SMUG gateway config manifests to S3.
      MemorySize: 256
      Timeout: 30
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Sid: WriteConfigObjects
              Effect: Allow
              Action:
                - s3:PutObject
                - s3:PutObjectTagging
                - s3:DeleteObject
                - s3:GetObject
              Resource:
                - !If
                  - CreateConfigBucket
                  - !Sub "arn:aws:s3:::${ConfigBucket}/*"
                  - !Sub "arn:aws:s3:::${UseExistingBucket}/*"
      Environment:
        Variables:
          SMUG_DEFAULT_BUCKET: !If [CreateConfigBucket, !Ref ConfigBucket, !Ref UseExistingBucket]

  SmugRuntimeApiProxyLayerArm64:
    Type: AWS::Serverless::LayerVersion
    Metadata:
      BuildMethod: makefile
      BuildArchitecture: arm64
    Properties:
      RetentionPolicy: Retain
      LayerName: !Sub "${AWS::StackName}-smug-runtime-api-proxy-arm64"
      ContentUri: layer-proxy
      CompatibleArchitectures:
        - arm64

  SmugRuntimeApiProxyLayerAmd64:
    Type: AWS::Serverless::LayerVersion
    Metadata:
      BuildMethod: makefile
      BuildArchitecture: x86_64
    Properties:
      RetentionPolicy: Retain
      LayerName: !Sub "${AWS::StackName}-smug-runtime-api-proxy-amd64"
      ContentUri: layer-proxy
      CompatibleArchitectures:
        - x86_64

  GatewayMacroFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.13
      Handler: app.handler
      CodeUri: gateway_macro/
      Description: CloudFormation macro that expands Smug::Gateway::Service into App Runner + supporting resources.
      MemorySize: 256
      Timeout: 30
      Policies:
        - AWSLambdaBasicExecutionRole
      Environment:
        Variables:
          SMUG_DEFAULT_GATEWAY_IMAGE_IDENTIFIER: !If
            - HasDefaultGatewayImageIdentifier
            - !Ref DefaultGatewayImageIdentifier
            - !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.${AWS::URLSuffix}/${DefaultGatewayRepositoryName}:${DefaultGatewayImageTag}'

  GatewayMacro:
    Type: AWS::CloudFormation::Macro
    Properties:
      Name: SmugGateway
      FunctionName: !GetAtt GatewayMacroFunction.Arn

Outputs:
  ConfigBucketName:
    Description: S3 bucket name where gateway config manifests are stored.
    Value: !If [CreateConfigBucket, !Ref ConfigBucket, !Ref UseExistingBucket]
    Export:
      Name: SmugConfigBucketName

  ConfigPublisherServiceToken:
    Description: Service token (Lambda ARN) for the Custom::SmugConfigPublisher resource.
    Value: !GetAtt ConfigPublisherFunction.Arn
    Export:
      Name: SmugConfigPublisherServiceToken

  GatewayMacroName:
    Description: CloudFormation macro name to add to the Transform section.
    Value: SmugGateway

  LayerArm64Arn:
    Description: ARN of the arm64 runtime API proxy layer.
    Value: !Ref SmugRuntimeApiProxyLayerArm64

  LayerAmd64Arn:
    Description: ARN of the amd64 runtime API proxy layer.
    Value: !Ref SmugRuntimeApiProxyLayerAmd64
